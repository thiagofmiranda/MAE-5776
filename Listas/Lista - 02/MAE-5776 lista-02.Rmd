---
title: 'MAE5776 - 1º Sem/2022 – Comparação de 2 Populações Np'
output:
  pdf_document: 
    pandoc_args: --listings
    includes:
      in_header: 
        preamble.tex
geometry: columnsep=3em
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE,message=FALSE)
options(scipen=999)

library(kableExtra)
library(tidyverse)
library(GGally)
library(ggpubr)
library(biotools)
library(formatR)

# Funções

# função para converter uma matrix em tex
texMatrix <- function(matrix, round = 2){
  matrix <- round(matrix,round)
  tex <- ""
  for(i in 1:nrow(matrix)){
    if(i != nrow(matrix)){
      tex <- paste0(tex,paste(matrix[i,],collapse = " & ")," \\\\ ")
    }else{
      tex <- paste0(tex,paste(matrix[i,],collapse = " & "))
    }
    
  }
  
  paste0("\\begin{pmatrix}",tex,"\\end{pmatrix}")
}
```

1 - Comparação de vetores de Médias de 2 populações N3. Teste T2 de Hotelling.

Gerar uma amostra aleatória de ng observações de duas populações Normais tridimensionais, $N_{3}(\mu_{g}; \Sigma_{g})$, envolvendo as variáveis Y1, Y2 e Y3. Preencha a tabela a seguir com os parâmetros adotados na simulação dos dados.

```{r}
# Vetor de médias
media_pop_1 <- c(5.0, 5.7, 5.5)
media_pop_2 <- c(5.8, 5.1, 5.7)

# Matrizes de covariâncias
cov_pop_1 <- matrix(c(1, 0.3, 0.5, 
                      0.3, 0.9, 0.2,
                      0.5, 0.2, 1.1),3,3,byrow=T)
cov_pop_2 <- matrix(c(1, 0.3, 0.5, 
                      0.3, 0.9, 0.2,
                      0.5, 0.2, 1.1),3,3,byrow=T)

# Matrizes de correlações
cor_pop_1 <- matrix(
  c(cov_pop_2[1,1]/(sqrt(cov_pop_2[1,1])*sqrt(cov_pop_2[1,1])),
    cov_pop_2[1,2]/(sqrt(cov_pop_2[1,1])*sqrt(cov_pop_2[2,2])),
    cov_pop_2[1,3]/(sqrt(cov_pop_2[1,1])*sqrt(cov_pop_2[3,3])),
    cov_pop_2[2,1]/(sqrt(cov_pop_2[2,2])*sqrt(cov_pop_2[1,1])),
    cov_pop_2[2,2]/(sqrt(cov_pop_2[2,2])*sqrt(cov_pop_2[2,2])),
    cov_pop_2[2,3]/(sqrt(cov_pop_2[2,2])*sqrt(cov_pop_2[3,3])),
    cov_pop_2[3,1]/(sqrt(cov_pop_2[3,3])*sqrt(cov_pop_2[1,1])),
    cov_pop_2[3,2]/(sqrt(cov_pop_2[3,3])*sqrt(cov_pop_2[2,2])),
    cov_pop_2[3,3]/(sqrt(cov_pop_2[3,3])*sqrt(cov_pop_2[3,3]))),
  3,3,byrow=T) 

cor_pop_2 <- matrix(
  c(cov_pop_2[1,1]/(sqrt(cov_pop_2[1,1])*sqrt(cov_pop_2[1,1])),
    cov_pop_2[1,2]/(sqrt(cov_pop_2[1,1])*sqrt(cov_pop_2[2,2])),
    cov_pop_2[1,3]/(sqrt(cov_pop_2[1,1])*sqrt(cov_pop_2[3,3])),
    cov_pop_2[2,1]/(sqrt(cov_pop_2[2,2])*sqrt(cov_pop_2[1,1])),
    cov_pop_2[2,2]/(sqrt(cov_pop_2[2,2])*sqrt(cov_pop_2[2,2])),
    cov_pop_2[2,3]/(sqrt(cov_pop_2[2,2])*sqrt(cov_pop_2[3,3])),
    cov_pop_2[3,1]/(sqrt(cov_pop_2[3,3])*sqrt(cov_pop_2[1,1])),
    cov_pop_2[3,2]/(sqrt(cov_pop_2[3,3])*sqrt(cov_pop_2[2,2])),
    cov_pop_2[3,3]/(sqrt(cov_pop_2[3,3])*sqrt(cov_pop_2[3,3]))),
  3,3,byrow=T)


# Simulação dos dados
set.seed(123)
pop_1 <- MASS::mvrnorm(100,media_pop_1,cov_pop_1) |> 
  as_tibble() |> 
  mutate(Pop = "Escola 1")

pop_2 <- MASS::mvrnorm(100,media_pop_2,cov_pop_2) |> 
  as_tibble() |> 
  mutate(Pop = "Escola 2")

pop <- bind_rows(pop_1, pop_2) |> 
  rename(Por = V1, Mat = V2, His = V3)

# outputs para a tabela em latex
media_pop_1_tex <- paste0("$\\mu_{1}=(",paste(media_pop_1,collapse = ", "),")$")
media_pop_2_tex <- paste0("$\\mu_{2}=(",paste(media_pop_2,collapse = ", "),")$")

cov_pop_1_tex <- paste0("$\\Sigma_{1}=",texMatrix(cov_pop_1),"$")
cov_pop_2_tex <- paste0("$\\Sigma_{2}=",texMatrix(cov_pop_2),"$")

cor_pop_1_tex <- paste0("$\\rho_{1}=",texMatrix(cor_pop_1),"$")
cor_pop_2_tex <- paste0("$\\rho_{2}=",texMatrix(cor_pop_2),"$")


# Tabela resumo
tb_1 <- tibble(
  População = c("Pop 1","Pop 2"),
  Amostra = c("$n_{1}=100$","$n_{2}=100$"),
  `Vetor de Médias` = c(media_pop_1_tex, media_pop_2_tex),
  `Matriz de Covariâncias` = c(cov_pop_1_tex,cov_pop_2_tex),
  `Matriz de Correlações` = c(cor_pop_1_tex,cor_pop_2_tex)
  )

# Exibindo tabela resumo
tb_1 %>%
  kbl(format = "latex",
      escape = FALSE,
      booktabs = TRUE,longtable = T) |> 
  kable_styling(font_size=8) 


```

1.1 - Contextualize, com uma situação prática hipotética, os dados gerados. Caracterize a estrutura dos dados (amostras balanceadas, observações independentes, tipo de variável, dimensão dos dados, etc). Defina o objetivo do estudo.

R: Podemos contextualizar os dados com sendo de notas de português, matemática e história de turmas do 3º ano do ensino médio de duas escolas de São Paulo. De um modo geral, os dados são compostos por 3 variáveis contínuas com um total de 200 observações e uma variável categórica definindo a população da amostra. São dados balanceados, contendo 100 obsevações em cada amostra e foram gerados de forma independente, onde a geração de cada observação não influenciou as demais. O objetivo desse estudo será comparar as notas médias das 3 disciplinas entre ambas as escolas.

\pagebreak

1.2 - Realize uma análise descritiva dos dados (calcule estatísticas descritivas, construa gráficos apropriados). Comente os resultados de acordo com o objetivo do estudo.

```{r}

media_amostra_1 <- colMeans(pop[pop$Pop == "Escola 1", -4])
media_amostra_2 <- colMeans(pop[pop$Pop == "Escola 2", -4])

cov_amostra_1 <- cov(pop[pop$Pop == "Escola 1", -4])
cov_amostra_2 <- cov(pop[pop$Pop == "Escola 2", -4])

cor_amostra_1 <- cor(pop[pop$Pop == "Escola 1", -4])
cor_amostra_2 <- cor(pop[pop$Pop == "Escola 2", -4])

# outputs para a tabela em latex
media_amostra_1_tex <- paste0("$\\bar{Y_{1}}=(",paste(round(media_amostra_1,2),collapse = ", "),")$")
media_amostra_2_tex <- paste0("$\\bar{Y_{2}}=(",paste(round(media_amostra_2,2),collapse = ", "),")$")

cov_amostra_1_tex <- paste0("$S_{u1}=",texMatrix(cov_amostra_1),"$")
cov_amostra_2_tex <- paste0("$S_{u2}=",texMatrix(cov_amostra_2),"$")

cor_amostra_1_tex <- paste0("$R_{1}=",texMatrix(cor_amostra_1),"$")
cor_amostra_2_tex <- paste0("$R_{2}=",texMatrix(cor_amostra_2),"$")

# Tabela resumo
tb_2 <- tibble(
  População = c("Escola 1","Escola 2"),
  Amostra = c("$n_{1}=100$","$n_{2}=100$"),
  `Vetor de Médias` = c(media_amostra_1_tex, media_amostra_2_tex),
  `Matriz de Covariâncias` = c(cov_amostra_1_tex,cov_amostra_2_tex),
  `Matriz de Correlações` = c(cor_amostra_1_tex,cor_amostra_2_tex)
  )

# Exibindo tabela resumo
tb_2 %>%
  kbl(format = "latex",
      escape = FALSE,
      booktabs = TRUE,longtable = T) |> 
  kable_styling(font_size=8)

ggpairs(pop, ggplot2::aes(colour=Pop)) 

```

R:

\pagebreak

1.3 - De acordo com as premissas adotadas na simulação dos dados, qual é a distribuição amostral da estatística $\bar{\bar{Y_{1}}} - \bar{\bar{Y_{2}}}$? Justifique. Com base nos dados simulados, construa um gráfico de quantis da Normal para validar os resultados.

R: Os dados foram simulados com base em duas nomais multivariadas, a estatística $\bar{\bar{Y_{1}}} - \bar{\bar{Y_{2}}}$ terá como distribuição amostral uma normal multivariada, pois qualquer combinação linear entre distribuições multivariada resultará em uma distribuição normal multivariada. Verificaremos se cada amostra tem distribuição normal multivariada, para tal, avaliaremos se soma das notas de português, matemática e história segue um distribuição normal.

Hipóteses para a amostra da Escola 1:
$$H_{0}: Por_{1} + Mat_{1} + His_{1} \sim N(\mu_{1}, \sigma^2_{1})$$
$$H_{1}: Por_{1} + Mat_{1} + His_{1} \nsim N(\mu_{1}, \sigma^2_{1})$$

```{r,out.width = '40%',fig.align='center'}
Amostra_1 <- pop |> 
  filter(Pop=="Escola 1") |> 
  mutate(PMH = Por + Mat + His)

ggqqplot(Amostra_1, x = "PMH")
```
Hipóteses para a amostra da Escola 2:
$$H_{0}: Por_{2} + Mat_{2} + His_{2} \sim N(\mu_{2}, \sigma^2_{2})$$
$$H_{1}: Por_{2} + Mat_{2} + His_{2} \nsim N(\mu_{2}, \sigma^2_{2})$$

```{r,out.width = '40%',fig.align='center'}
Amostra_2 <- pop |> 
  filter(Pop=="Escola 2") |> 
  mutate(PMH = Por + Mat + His)

ggqqplot(Amostra_2, x = "PMH")
```

A partir dos QQ-plots apresentados, verificamos que as soma das variáveis nas duas escolas têm distribuições amostrais normais, evidenciando que, conjutamente, cada escola tem distribuição amostral multivariada nas notas de português, matemática e história. Consequentemente, $\bar{\bar{Y_{1}}} - \bar{\bar{Y_{2}}}$ também resultará em uma $N(\mu_{1}-\mu_{2}, \sigma^2_{1}-\sigma^2_{2})$. 

\pagebreak

1.4 - Há evidência amostral de diferença significante entre os vetores de Médias das duas populações? Justifique.

R:

```{r echo=FALSE}
teste_boxM <- boxM(data = pop[,-4], grouping = pop$Pop) 
teste_boxM
```

Como o p-valor de `r round(teste_boxM$p.value,4)` é maior que o nível de significância de 5%. Não rejeitamos a hipótese nula de que
as matrizes de covariancias são iguais.

```{r echo=FALSE}
library(Hotelling)
teste_t2_hotelling <- hotelling.test(pop[pop$Pop=="Escola 1",-4],pop[pop$Pop=="Escola 2",-4], var.equal = TRUE)
teste_t2_hotelling
```
Como o p-valor de `r round(teste_t2_hotelling$pval,4)` é menor que o nível de significância de 5%. Rejeitamos a hipótese nula 
e concluímos que há algumas diferença entre as médias das escolas para as disciplinas de português, matemática e história.



1.5 - Para cada variável, compare as médias das duas populações. Utilize correções de Bonferroni e FDR na conclusão dessas comparações. Qual variável mais contribui para a possível diferença entre as populações?

```{r echo=FALSE}
por_bartlettteste <- bartlett.test(pop$Por ~ pop$Pop) 
por_bartlettteste
por_ttteste <- t.test(pop$Por ~ pop$Pop, conf.level=0.95, var.equal=TRUE)
por_ttteste 
```
Como o p-valor do teste T de `r round(por_bartlettteste$p.value,4)` é maior que o nível de significância de 5%, não rejeitamos a hipóteses nula e concluímos que as variâncias das notas de português entre os grupos são homogêneas. E como o p-valor do teste T de `r round(por_ttteste$p.value,4)` é menor que o nível de significância de 5%, rejeitamos a hipóteses nula e concluímos que as médias das notas de português entre as escolas 1 e 2 são diferentes,ao nível de 95% de confiança. 


```{r echo=FALSE}
mat_bartlettteste <- bartlett.test(pop$Mat ~ pop$Pop) 
mat_bartlettteste
mat_ttteste <- t.test(pop$Mat ~ pop$Pop,conf.level=0.95,var.equal=TRUE)
mat_ttteste
```
Como o p-valor do teste T de `r round(mat_bartlettteste$p.value,4)` é maior que o nível de significância de 5%, não rejeitamos a hipóteses nula e concluímos que as variâncias das notas de matemática entre os grupos são homogêneas. E como o p-valor do teste T de `r round(mat_ttteste$p.value,4)` é menor que o nível de significância de 5%, rejeitamos a hipóteses nula e concluímos que as médias das notas de matemática entre as escolas 1 e 2 são diferentes,ao nível de 95% de confiança. 

```{r echo=FALSE, message=TRUE}
his_bartlettteste <- bartlett.test(pop$His ~ pop$Pop) 
his_bartlettteste
his_ttteste <- t.test(pop$His ~ pop$Pop,conf.level=0.95,var.equal=TRUE)
his_ttteste
```
Como o p-valor do teste T de `r round(his_bartlettteste$p.value,4)` é maior que o nível de significância de 5%, não rejeitamos a hipóteses nula e concluímos que as variâncias das notas de história entre os grupos são homogêneas. E como o p-valor do teste T de `r round(his_ttteste$p.value,4)` é menor que o nível de significância de 5%, rejeitamos a hipóteses nula e concluímos que as médias das notas de história entre as escolas 1 e 2 são diferentes,ao nível de 95% de confiança. 

```{r}
#Obter os p-valores (bicaudal) individuais com correção para múltiplos testes
p.result <- c(por_ttteste$p.value,mat_ttteste$p.value,his_ttteste$p.value)
p.result  

padjustB <- p.adjust(p.result,method="bonferroni")
padjustFDR <- p.adjust(p.result,method="fdr")

padjusts <- tibble(Disciplina=c("Por","Mat","His")) |> 
  mutate(p.result = round(p.result,6)) |> 
  mutate(padjustB = round(padjustB,6)) |> 
  mutate(padjustFDR = round(padjustFDR,6))

padjusts %>%
  kbl(format = "latex",
      escape = FALSE,
      booktabs = TRUE,longtable = T)
```




2 - Comparação de vetores de Médias de Normais tridimensionais, $N_{3}$, em Delineamentos Completamente Aleatorizados com Estrutura Fatorial Cruzado 2x2 - MANOVA

Gerar dados da N3 de acordo com um Delineamento Completamente Aleatorizado (DCA) Fatorial Cruzado 2x2. Considerando os Fatores F1 e F2, cada um em dois níveis, 0 e 1, preencha a tabela a seguir com os parâmetros adotados na simulação dos dados.

```{r}
media_pop_1 <- c(12, 15, 23)
media_pop_2 <- c(13, 15, 22)
media_pop_3 <- c(9, 14, 18)
media_pop_4 <- c(13, 17, 26)

cov_pop <- matrix(c(3, 1.2, 1.9, 
                    1.2, 2, 1.5,
                    1.9, 1.5, 3),3,3,byrow=T)

cor_pop <- matrix(
  c(cov_pop_2[1,1]/(sqrt(cov_pop_2[1,1])*sqrt(cov_pop_2[1,1])),
    cov_pop_2[1,2]/(sqrt(cov_pop_2[1,1])*sqrt(cov_pop_2[2,2])),
    cov_pop_2[1,3]/(sqrt(cov_pop_2[1,1])*sqrt(cov_pop_2[3,3])),
    cov_pop_2[2,1]/(sqrt(cov_pop_2[2,2])*sqrt(cov_pop_2[1,1])),
    cov_pop_2[2,2]/(sqrt(cov_pop_2[2,2])*sqrt(cov_pop_2[2,2])),
    cov_pop_2[2,3]/(sqrt(cov_pop_2[2,2])*sqrt(cov_pop_2[3,3])),
    cov_pop_2[3,1]/(sqrt(cov_pop_2[3,3])*sqrt(cov_pop_2[1,1])),
    cov_pop_2[3,2]/(sqrt(cov_pop_2[3,3])*sqrt(cov_pop_2[2,2])),
    cov_pop_2[3,3]/(sqrt(cov_pop_2[3,3])*sqrt(cov_pop_2[3,3]))),
  3,3,byrow=T)

set.seed(123)
pop_1 <- MASS::mvrnorm(50,media_pop_1,cov_pop) |> 
  as_tibble() |>
  mutate(F1 = 1,F2 = 0)
pop_2 <- MASS::mvrnorm(50,media_pop_2,cov_pop) |> 
  as_tibble() |>
  mutate(F1 = 1,F2 = 1)
pop_3 <- MASS::mvrnorm(50,media_pop_3,cov_pop) |> 
  as_tibble() |>
  mutate(F1 = 0,F2 = 0)
pop_4 <- MASS::mvrnorm(50,media_pop_4,cov_pop) |> 
  as_tibble() |>
  mutate(F1 = 0,F2 = 1)

pop <- bind_rows(pop_1, pop_2, pop_3, pop_4) |> 
  rename(uva = V1, banana = V2, laranja = V3)
```


\[tabela\]

2.1 - Contextualize, com uma situação prática hipotética, os dados gerados. Caracterize a estrutura dos dados e defina o objetivo do estudo.

R: Os dados são referentes a um experimento fatorial 2x2, onde averiguou-se a produção em toneladas por hectare de três tipos de frutas (uva, banana e laranja) sob o efeito de dois tipos de adubos (F1 e F2). O objetivo principal do estudo é verifical qual adubo tem melhor efeito sobre a produção das frutas. 

2.2 - Realize uma análise descritiva dos dados (calcule estatísticas descritivas, construa gráficos apropriados). Comente os resultados de acordo com o objetivo do estudo.

```{r}
medias <- pop |> 
  group_by(F1, F2) |> 
  dplyr::summarise(med_uva = mean(uva),
                   med_banana = mean(banana),
                   med_laranja = mean(laranja))
medias

cov_amostra_1 <- cov(pop[pop$F1==1 & pop$F2==0, -c(4,5)])
cov_amostra_2 <- cov(pop[pop$F1==1 & pop$F2==1, -c(4,5)])
cov_amostra_3 <- cov(pop[pop$F1==0 & pop$F2==0, -c(4,5)])
cov_amostra_4 <- cov(pop[pop$F1==0 & pop$F2==1, -c(4,5)])

cor_amostra_1 <- cor(pop[pop$F1==1 & pop$F2==0, -c(4,5)])
cor_amostra_2 <- cor(pop[pop$F1==1 & pop$F2==1, -c(4,5)])
cor_amostra_3 <- cor(pop[pop$F1==0 & pop$F2==0, -c(4,5)])
cor_amostra_4 <- cor(pop[pop$F1==0 & pop$F2==1, -c(4,5)])
```

```{r,out.width = '80%',fig.align='center'}
ggpairs(pop[,-c(4,5)],ggplot2::aes(colour="1"),,title = "Descritivas gerais")+
  scale_fill_manual(values = c("#2a9d8f"))+
  scale_color_manual(values = c("#457b9d"))

pop |> 
  mutate(F1 = as.factor(F1)) |> 
  dplyr::select(-F2) |> 
  ggpairs(ggplot2::aes(colour=F1),title = "Descritivas para F1")+
  scale_fill_manual(values = c("#2a9d8f","#264653"))+
  scale_color_manual(values = c("#2a9d8f","#264653"))

pop |> 
  mutate(F2 = as.factor(F2)) |> 
  dplyr::select(-F1) |> 
  ggpairs(ggplot2::aes(colour=F2),title = "Descritivas para F2")+
  scale_fill_manual(values = c("#457b9d","#1d3557"))+
  scale_color_manual(values = c("#457b9d","#1d3557"))
```




2.3 - Construa a Tabela de MANOVA para a análise destes dados. Considere as fontes de variação devido aos efeitos principais dos fatores F1 e F2 e sua interação $F1*F2$, os correspondentes números de graus de liberdade e as Somas de Quadrados e Produtos Cruzados (SSF1, SSF2, e SSF1\*F2, bem como SSW). Há evidência amostral de efeito significante dos fatores sob estudo?

1.4 - De acordo com os resultados da MANOVA, realize comparações múltiplas para estudar os efeitos significantes dos fatores. Utilize correções de Bonferroni e FDR. Interprete os resultados.

1.5 - Da tabela MANOVA obtida em 1.3 construa a correspondente tabela MANOVA de um estudo que considera o efeito total dos 4 grupos definidos pela estrutura fatorial 2x2. Neste caso, seja SSF a Soma de Quadrados e Produtos Cruzados do referido fator em 4 níveis. Há efeito significante deste fator F que combina os níveis de F1 e F2?

1.6 - Obtenha a decomposição espectral (autovalores e autovetores) das seguintes matrizes: $SS_{W}^{-1}SS_{F1}, SS_{W}^{-1}SS_{F2}, SS_{W}^{-1}SS_{F1*F2}, SSW^{-1}SS_{F}$. Qual é o padrão de contribuição das variáveis para cada um dos efeitos considerados?
